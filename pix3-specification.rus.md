# Техническая спецификация: Pix3 Редактор

**Версия:** 1.4  
**Дата:** 25.09.2025

## 1. Введение

### 1.1. Назначение документа

Этот документ описывает технические требования, архитектуру и план разработки для веб-приложения **Pix3** — современного редактора для создания HTML5-игр, сочетающего 2D и 3D возможности.

### 1.2. Обзор продукта

Pix3 — это браузерный редактор, аналог Figma и Unity, предназначенный для быстрой итеративной разработки игровых сцен. Он позволяет работать с файлами проекта напрямую через File System Access API, обеспечивая тесную интеграцию с внешними IDE (например, VS Code) для редактирования кода.

## 2. Ключевые особенности

- **Гибридная 2D/3D сцена:** Редактор не имеет жесткого разделения на 2D и 3D режимы. Вместо этого он использует систему слоев, позволяя накладывать 2D-интерфейсы поверх 3D-сцен, что идеально подходит для создания UI игр.
- **Структура сцены в стиле Godot:** Архитектура сцены основана на иерархии "нод" (узлов). Каждая нода представляет собой объект (спрайт, 3D-модель, источник света). Ноды можно сохранять в отдельные файлы сцен (*.pix3scene) и переиспользовать (инстанциировать) внутри других сцен.
- **Работа с локальной файловой системой:** Pix3 работает напрямую с папкой проекта на диске пользователя через File System Access API. Это устраняет необходимость в загрузке/выгрузке файлов и обеспечивает бесшовную синхронизацию с внешними редакторами кода.
- **Многовкладочный интерфейс:** Пользователи могут одновременно открывать и редактировать несколько сцен в разных вкладках, что упрощает работу над сложными проектами.
- **Drag-and-Drop ассетов:** Ресурсы проекта (изображения, модели) можно перетаскивать напрямую из файлового браузера редактора в окно сцены для создания нод.
- **Настраиваемый интерфейс:** Пользователь может перемещать и прикреплять панели редактора к разным областям окна, аналогично VS Code, сохраняя свою раскладку между сессиями.

## 3. Технологический стек

| Категория          | Технология                  | Обоснование |
|-------------------:|:---------------------------|:--------------|
| UI-компоненты      | Lit                        | Легковесная библиотека для создания нативных, быстрых и инкапсулированных веб-компонентов.
| Состояние (State)  | Valtio                     | Ультралегкий, производительный менеджер состояний на основе прокси. Обеспечивает реактивность и прост в использовании.
| Рендеринг 2D       | PixiJS                     | Высокопроизводительный 2D-рендер с автоматическим использованием WebGL.
| Рендеринг 3D       | Three.js                   | Наиболее популярная и гибкая библиотека для 3D-графики в вебе.
| Компоновка панелей | Golden Layout              | Готовое решение для создания сложных, настраиваемых и сохраняемых раскладок панелей.
| Язык               | TypeScript                 | Строгая типизация для повышения надежности, улучшения автодополнения и упрощения работы с ИИ-агентами.
| Сборка проекта     | Vite                       | Современный и чрезвычайно быстрый сборщик, идеально подходящий для разработки на нативных технологиях.
| Файловая система   | File System Access API     | Позволяет работать с локальными файлами напрямую из браузера без Electron.

## 4. Архитектура

Приложение будет построено на принципах **однонаправленного потока данных** и четкого разделения ответственности.

- **State (Состояние):** Централизованное хранилище на базе **Valtio**, являющееся единственным источником правды. Оно пассивно и не содержит бизнес-логики.
- **Commands (Команды/Операции):** Маленькие, изолированные классы, содержащие всю бизнес-логику. Только они имеют право изменять State. Этот паттерн является основой для системы Undo/Redo.
- **Core Managers (Менеджеры ядра):** Классы, управляющие основными аспектами редактора (HistoryManager, SceneManager, PluginManager). Они оркестрируют выполнение команд.
- **Services (Сервисы):** Инфраструктурный слой для взаимодействия с внешним миром (FileSystemAPIService). Они не содержат бизнес-логики.
- **UI Components (Компоненты):** "Глупые" Lit-компоненты, которые только отображают State и вызывают Commands в ответ на действия пользователя.
- **Plugins (Плагины):** Расширяемый механизм, позволяющий добавлять новую функциональность (инструменты, панели, команды) без изменения ядра редактора.

## 5. Формат файла сцены (*.pix3scene)

Файл сцены будет использовать формат **YAML** для обеспечения читаемости как для человека, так и для машин (включая ИИ-агентов).

### 5.1. Ключевые принципы

- **Декларативность:** Файл описывает состав и структуру сцены, а не процесс ее создания.
- **Ссылки на ассеты:** Ассеты (модели, текстуры) не встраиваются в файл, а указываются через относительные пути с префиксом res:// (путь от корня проекта).
- **Композиция:** Сложные сцены собираются из более простых путем инстанциирования других файлов сцен.
- **Однозначность структуры:** Явный ключ children используется для обозначения списка дочерних узлов, что отделяет иерархию от свойств самого узла.
- **Уникальная идентификация:** Каждый узел **обязательно** имеет поле id. В качестве значения используется короткий, криптографически надежный уникальный идентификатор (аналог **Nano ID**), чтобы обеспечить баланс между читаемостью файла и абсолютной надежностью ссылок.

### 5.2. Пример структуры

```yaml
# --- Metadata ---
version: 1.0
description: "Главная сцена первого уровня"

# --- Node Hierarchy ---
root:
  # Каждый узел имеет уникальный ID, тип, имя и свойства
  - id: "V1StGXR8_Z5jdHi6B-myT"
    type: "Node3D"
    name: "World"
    properties:
      position: { x: 0, y: 0, z: 0 }
      rotation: { x: 0, y: 0, z: 0 }

    # Явное определение дочерних узлов для однозначности
    children:
      - id: "b-s_1Z-4f8_c-9T_2f-3d"
        # Инстанция другой сцены (префаб)
        instance: "res://scenes/player.pix3scene"
        name: "Player"
        properties:
          # Переопределение свойств инстанции
          position: { x: 0, y: 1, z: 5 }

      - id: "k-9f_8g-7h_6j-5k_4l-1"
        type: "MeshInstance3D"
        name: "Ground"
        properties:
          # Ссылка на ассет
          mesh: "res://assets/models/ground_plane.glb"
          scale: { x: 100, y: 1, z: 100 }
```

## 6. План MVP (Minimum Viable Product)

- Настройка проекта с Vite, TypeScript и Lit.
- Реализация базовой архитектуры: AppState на Valtio, Command pattern.
- Интеграция FileSystemAPIService для открытия папки проекта и чтения файлов.
- Интеграция Golden Layout для создания базовой раскладки: Scene Tree, Viewport, Inspector, Asset Browser.
- Реализация рендеринга простой 3D-сцены с помощью Three.js во вьюпорте.
- Создание SceneManager для парсинга и отображения структуры сцены (*.pix3scene).
- Реализация плагина pix3-basic-tools-plugin, добавляющего инструмент для создания примитивов (например, куба).
- Базовая система Undo/Redo с помощью HistoryManager.

## 7. Структура проекта

```
/
├── dist/                     # Папка для скомпилированного приложения
├── public/                   # Статические ресурсы (иконки, шрифты)
├── src/
│   ├── components/           # UI Компоненты (панели, кнопки, инспекторы)
│   │   ├── inspector/
│   │   │   └── inspector-panel.ts
│   │   ├── scene/
│   │   │   └── scene-tree.ts
│   │   └── viewport/
│   │       └── viewport-component.ts
│   │
│   ├── core/                 # Ядро приложения (основная бизнес-логика)
│   │   ├── commands/         # Паттерн команд для всех действий
│   │   │   └── command.ts    # Базовый класс/интерфейс для команд
│   │   ├── history/
│   │   │   └── HistoryManager.ts # Менеджер Undo/Redo
│   │   ├── layout/
│   │   │   └── LayoutManager.ts  # Управление панелями (Golden Layout)
│   │   ├── plugins/
│   │   │   └── PluginManager.ts  # Загрузка и управление плагинами
│   │   └── scene/
│   │       ├── nodes/          # Классы для каждого типа узлов
│   │       │   ├── NodeBase.ts
│   │       │   ├── Node3D.ts
│   │       │   └── Sprite2D.ts
│   │       ├── SceneManager.ts # Управление сценой и узлами
│   │       └── types.ts      # Агрегатор типов, экспортирует классы из /nodes
│   │
│   ├── plugins/              # Папка для плагинов
│   │   └── pix3-basic-tools-plugin/
│   │       ├── commands/
│   │       │   └── create-primitive.ts
│   │       ├── components/
│   │       │   └── tool-options.ts
│   │       └── pix3-basic-tools-plugin.ts # Основной файл плагина
│   
│   ├── services/             # Инфраструктурные сервисы (взаимодействие с "внешним миром")
│   │   ├── FileSystemAPIService.ts
│   │   └── CollaborationService.ts (для будущего)
│   
│   ├── state/                # Глобальное состояние приложения
│   │   ├── AppState.ts       # Определение состояния (с Valtio)
│   │   └── index.ts          # Экспорт прокси состояния
│   
│   ├── rendering/            # Логика рендеринга (мост к Three.js/PixiJS)
│   │   ├── WebGLRenderer.ts
│   │   └── Canvas2DRenderer.ts
│   
│   ├── styles/               # Глобальные стили
│   │   └── main.css
│   
│   ├── utils/                # Вспомогательные функции
│   
│   └── main.ts               # Точка входа приложения
│
├── index.html
├── package.json
├── tsconfig.json
└── vite.config.ts

```
