# Техническая спецификация: Pix3 Редактор

**Версия:** 1.8  
**Дата:** 05.10.2025

## 1. Введение

### 1.1. Назначение документа

Этот документ описывает технические требования, архитектуру и план разработки для веб-приложения **Pix3** — современного редактора для создания HTML5-игр, сочетающего 2D и 3D возможности.

### 1.2. Обзор продукта

Pix3 — это браузерный редактор, аналог Figma и Unity, предназначенный для быстрой итеративной разработки игровых сцен. Он позволяет работать с файлами проекта напрямую через File System Access API, обеспечивая тесную интеграцию с внешними IDE (например, VS Code) для редактирования кода.

### 1.3. Целевая аудитория

Pix3 ориентирован на профессиональные и инди-команды, создающие playable-рекламу и интерактивные WebGL-опыты:

- **Создатели playable ads на PixiJS/Three.js**, которым нужны инструменты сцены и быстрая итерация.
- **Пользователи Construct 3 и Godot**, ищущие браузерный workflow без тяжёлой установки.
- **Разработчики на Cocos и собственных движках**, которым важна визуальная сборка UI и сцен перед экспортом в код.

Метрики успеха:

- Создание новой сцены playable-рекламы от шаблона до экспорта менее чем за 30 минут на среднем железе.
- Поддержание ≥ 85 FPS редактора для сцены с тремя слоями (UI + 3D + частицы) в Chromium-браузерах на ноутбуках 2023+.
- 90% пользовательских действий доступно через хоткеи или палитру команд в рамках MVP.

### 1.4. Область документа и управление изменениями

Спецификация описывает MVP и фундамент архитектуры. Изменения фиксируются в журнале в конце документа. Версия 1.5 отражает целевые платформы, расширенные нефункциональные требования и уточнённые архитектурные рекомендации.

## 2. Ключевые особенности

- **Гибридная 2D/3D сцена:** Редактор не имеет жесткого разделения на 2D и 3D режимы. Вместо этого он использует систему слоев, позволяя накладывать 2D-интерфейсы поверх 3D-сцен, что идеально подходит для создания UI игр.
- **Структура сцены в стиле Godot:** Архитектура сцены основана на иерархии "нод" (узлов). Каждая нода представляет собой объект (спрайт, 3D-модель, источник света). Ноды можно сохранять в отдельные файлы сцен (*.pix3scene) и переиспользовать (инстанциировать) внутри других сцен.
- **Работа с локальной файловой системой:** Pix3 работает напрямую с папкой проекта на диске пользователя через File System Access API. Это устраняет необходимость в загрузке/выгрузке файлов и обеспечивает бесшовную синхронизацию с внешними редакторами кода.
- **Многовкладочный интерфейс:** Пользователи могут одновременно открывать и редактировать несколько сцен в разных вкладках, что упрощает работу над сложными проектами.
- **Drag-and-Drop ассетов:** Ресурсы проекта (изображения, модели) можно перетаскивать напрямую из файлового браузера редактора в окно сцены для создания нод.
- **Настраиваемый интерфейс:** Пользователь может перемещать и прикреплять панели редактора к разным областям окна, аналогично VS Code, сохраняя свою раскладку между сессиями.
- **Пресеты рабочих пространств:** Готовые конфигурации (Playable Ad, 3D Scene Authoring, UI Overlay), соответствующие основным персонам.

## 3. Технологический стек

| Категория          | Технология                  | Обоснование |
|-------------------:|:---------------------------|:--------------|
| UI-компоненты      | Lit + хелперы fw           | Легковесная библиотека и проектные хелперы (`ComponentBase`, `inject`), обеспечивающие единообразие DOM, DI и конфигурации.
| Состояние (State)  | Valtio                     | Ультралегкий, производительный менеджер состояний на основе прокси. Обеспечивает реактивность и прост в использовании.
| Рендеринг (MVP)    | Three.js                   | Один движок для 3D-перспективы и 2D-оверлеев (ортографическая камера), что уменьшает размер сборки для playable ads.
| 2D-оверлеи         | Three.js (ортографическая) | Орто-камера + спрайты/материалы обрабатывают HUD и UI без второй библиотеки.
| Компоновка панелей | Golden Layout              | Готовое решение для создания сложных, настраиваемых и сохраняемых раскладок панелей.
| Язык               | TypeScript                 | Строгая типизация для повышения надежности, улучшения автодополнения и упрощения работы с ИИ-агентами.
| Сборка проекта     | Vite                       | Современный и чрезвычайно быстрый сборщик, идеально подходящий для разработки на нативных технологиях.
| Файловая система   | File System Access API     | Позволяет работать с локальными файлами напрямую из браузера без Electron.

### 3.1. Целевые платформы

- **Браузеры:** Настольные Chromium-браузеры (Chrome, Edge, Arc, Brave) — две последние стабильные версии.
- **ОС:** Windows 11+, macOS 13+, Ubuntu 22.04+ (через Chromium).
- **Базовое железо:** Интегрированная GPU (Intel Iris Xe / AMD Vega) c поддержкой WebGL2, 8 ГБ RAM, 4-ядерный CPU.

Браузеры вне Chromium (Firefox, Safari) не входят в MVP, но должны отображать информационный баннер о несовместимости.

## 4. Архитектура

Приложение будет построено на принципах **однонаправленного потока данных** и четкого разделения ответственности.

- **State (Состояние):** Централизованное хранилище на базе **Valtio**, являющееся единственным источником правды. Оно пассивно и не содержит бизнес-логики.
- **Операции и команды:** Операции — первоклассные сущности, инкапсулирующие бизнес-логику и изменения состояния. `OperationService` — единственная точка входа для выполнения, undo и redo. Команды существуют как тонкие обёртки: проверяют предусловия и делегируют выполнение операций через `OperationService`. UI/инструменты могут вызывать операции напрямую при необходимости.
- **Core Managers (Менеджеры ядра):** Классы, управляющие основными аспектами редактора (HistoryManager, SceneManager, PluginManager). Они оркестрируют выполнение команд.
- **Services (Сервисы):** Инфраструктурный слой для взаимодействия с внешним миром (FileSystemAPIService). Они не содержат бизнес-логики.
- **UI Components (Компоненты):** "Глупые" Lit-компоненты, построенные поверх хелперов `fw`. Предпочтительно наследоваться от `ComponentBase`, управлять DOM через `useShadowDom` и внедрять сервисы через `inject`.
- **Plugins (Плагины):** Расширяемый механизм, позволяющий добавлять новую функциональность (инструменты, панели, команды) без изменения ядра редактора.
- **Message Bus (Шина сообщений):** Лёгкий pub/sub-слой, связывающий состояние, команды и плагины. Команды эмитят события, UI-компоненты подписываются на типизированные каналы.
- **Слой рендеринга:** Единый пайплайн Three.js выполняет перспективный (3D) и ортографический (2D) проходы. 2D элементы (HUD, гизмо, выделения) рендерятся орто-камерой со спрайтами и примитивами — без отдельного PixiJS.

### Рекомендуемый паттерн компонента

Используйте утилиты `fw`, экспортируемые из `docs/fw/index.ts`, при создании UI-компонентов. Пример:

```typescript
import { customElement, html, css, property, ComponentBase, inject } from 'docs/fw';

@customElement('my-inspector')
export class MyInspector extends ComponentBase {
  @property({ type: String }) title = 'Inspector';

  @inject()
  dataService!: DataService; // резолвится через fw/di

  render() {
    return html`<div class="inspector"><h3>${this.title}</h3></div>`;
  }
}
```

Примечания:
- `ComponentBase` по умолчанию использует light DOM, но позволяет включить shadow DOM через статическое поле `useShadowDom`.
- Декоратор `inject` автоматически разрешает сервисы, зарегистрированные в контейнере `fw/di`. Регистрация выполняется через `@injectable()` при включённых `emitDecoratorMetadata` и `reflect-metadata`.
- Плагины — основной способ расширения функциональности (панели, команды, инструменты) без модификации ядра.

### 4.1. Контракты архитектуры

- **Жизненный цикл операции (источник правды):** операция реализует `perform(context)` и возвращает `OperationCommit` с замыканиями `undo()`/`redo()` и метаданными коалесцирования. `OperationService` выполняет операции, по запросу кладёт коммиты в историю, эмитит телеметрию и единолично отвечает за undo/redo.
- **Жизненный цикл команды (тонкая обёртка):** `preconditions()` → `execute()`; команда делегирует выполнение в `OperationService` и сама не реализует undo/redo. Команды остаются идемпотентными; телеметрия идёт через `OperationService`.
- **HistoryManager:** Поддерживает ограниченный стек снимков команд, интегрируется с блокировками при совместной работе, экспонирует сигналы `canUndo`/`canRedo`.
- **SceneManager:** Парсит `.pix3scene`, разрешает инстансы, применяет переопределения и эмитит диффы для рендеров.
- **PluginManager:** Обнаруживает плагины (`manifest.json` с полем `capabilities`), проверяет подписи и изолирует регистрацию команд по пространствам имён.
- **Сервисы:** Реализуют `dispose()`, регистрируются через DI и лениво создаются при первом внедрении.

### 4.2. Глоссарий

- **Нода:** атомарный элемент графа сцены (спрайт, меш, источник света).
- **Сцена:** YAML-документ с иерархией корневых нод и ссылками на ассеты.
- **Инстанс:** включение другой сцены в активную с возможностью переопределений.
- **Пресет:** сохранённая компоновка интерфейса под конкретный сценарий работы персоны.
- **Команда:** единица бизнес-логики, изменяющая состояние и поддерживающая undo/redo.

### 4.3. Пайплайн с приоритетом операций

- **OperationService:** центральный оркестратор. Методы: `invoke(op)`, `invokeAndPush(op)` (выполнить и записать в историю), `undo()`, `redo()`. Ограниченные стеки (по умолчанию 100), очистка Redo при новых операциях, коалесцирование, типизированные события для UI и телеметрии.
- **Контракт операции:** `perform()` возвращает `OperationCommit` с `undo`/`redo` замыканиями; опционально — метаданные затронутых нод/структуры для эффективного диффинга.
- **Групповые операции:** инструменты могут объединять ряд атомарных операций в одну undo-точку через коалесцирующий коммит.
- **Интеграция UI/инструментов:** панели и инструменты вызывают операции напрямую через `OperationService`. Команды — опциональные тонкие фасады для палитры/шорткатов и не содержат логики undo.
- **Точки телеметрии:** все мутации проходят через `OperationService`, что упрощает аналитику, автосохранение и синхронизацию.

### 4.4. Примечания по рендерингу

- **Один движок:** Все 3D и 2D слои обслуживаются Three.js для минимизации сложности и размера бандла.
- **Разделение слоёв логическое:** Используются внутренние фазы (viewport pass, overlay pass), а не разные движки. Это упрощает сопровождение.
- **Расширяемость:** Возможность подключения отдельного 2D-движка сейчас исключена из дорожной карты; при необходимости позже можно внедрить через те же абстракции сервисов рендера.
- **Тестирование:** Планируются интеграционные тесты на корректность resize, DPR и порядка проходов в едином пайплайне.

## Статус реализации (текущее состояние репозитория)

Репозиторий содержит рабочий MVP-скелет и небольшой функциональный пайплайн рендеринга. Ниже приведён список конкретных элементов, уже реализованных в кодовой базе, с указанием основных файлов для быстрого поиска поведения.

- **Рендеринг вьюпорта:** Вьюпорт на базе Three.js реализован и экспонирован через `ViewportRendererService` (`src/rendering/ViewportRendererService.ts`). Он предоставляет перспективный проход (3D) плюс ортографический оверлей для HUD/прицела.
- **Обработка DPI и изменения размера:** Рендерер и панель вьюпорта корректно обрабатывают device pixel ratio (DPR) и изменение размера макета для пиксельно-идеального вывода. Ключевые файлы:
  - `src/rendering/ViewportRendererService.ts` — логика изменения размера с учётом DPR, явное CSS-размерение канваса, обновление аспекта оверлей-камеры и опрос DPR/макета в цикле рендера.
  - `src/components/viewport/viewport-panel.ts` — наблюдает за канвасом с помощью `ResizeObserver` и инициализирует рендерер с измеренным размером канваса.
- **Управление и демо-сцена:** Орбитальные контролы, демо-куб, освещение и оси-помощники подключены в сервисе вьюпорта для видимой сцены по умолчанию (`setupDemoScene`, `setupControls`).
- **Парсинг и валидация сцен:** `SceneManager` парсит YAML-файлы `.pix3scene` и валидирует их с помощью AJV. Недавно применено типобезопасное исправление для обработки указателей ошибок AJV (`src/core/scene/SceneManager.ts`).
- **Сборка и инструменты разработки:** Проект Vite + TypeScript настроен с dev (`npm run dev`), build (`npm run build`) и тестами (Vitest) в репозитории. Скрипты, подходящие для CI, есть в `package.json`.
- **Панели и макет:** Оболочка и панели на базе Golden Layout существуют и подключены к DI-контейнеру (`src/components/*`, `src/core/layout/`). Компонент `pix3-viewport-panel` монтирует канвас и координирует инициализацию рендерера.
- **История с приоритетом операций:** UI вызывает операции через `OperationService`. Команды — тонкие обёртки, делегирующие операциям. Команды undo/redo делегируют `OperationService.undo()`/`redo()`.

Известные пробелы / следующие задачи

- (Удалено) Предыдущий план адаптера оверлея PixiJS устарел; ортографический проход Three.js обеспечивает достаточную 2D-способность для MVP.
- **Фиксированный пиксельный оверлей:** Если нужен оверлей, всегда измеряющий N экранных пикселей (для UI-хрома или пиксельно-идеальных гайдов), можно добавить небольшой хелпер для вычисления ортографических границ из размера пикселей или рендерить HUD через HTML-оверлей.
- **Тесты:** Юнит/интеграционные тесты существуют для core-менеджеров, но добавление интеграционного теста, проверяющего поведение изменения размера/DPR для `ViewportRendererService`, было бы полезно.
- **Настройка производительности:** Продакшн-сборка выдаёт предупреждение о размере чанков для некоторых бандлов; рассмотрите code-splitting для больших опциональных модулей (например, пакетов плагинов) для уменьшения начального размера бандла.

Если хотите, я могу: 1) добавить небольшой интеграционный тест для поведения изменения размера рендерера, 2) реализовать опцию фиксированного пиксельного оверлея или 3) добавить небольшую запись в README, документирующую жизненный цикл рендерера и где подключать данные сцены. Скажите, что именно, и я реализую.

## 5. Формат файла сцены (*.pix3scene)

Файл сцены будет использовать формат **YAML** для обеспечения читаемости как для человека, так и для машин (включая ИИ-агентов).

### 5.1. Ключевые принципы

- **Декларативность:** Файл описывает состав и структуру сцены, а не процесс ее создания.
- **Ссылки на ассеты:** Ассеты (модели, текстуры) не встраиваются в файл, а указываются через относительные пути с префиксом res:// (путь от корня проекта).
- **Композиция:** Сложные сцены собираются из более простых путем инстанциирования других файлов сцен.
- **Однозначность структуры:** Явный ключ children используется для обозначения списка дочерних узлов, что отделяет иерархию от свойств самого узла.
- **Уникальная идентификация:** Каждый узел **обязательно** имеет поле id. В качестве значения используется короткий, криптографически надежный уникальный идентификатор (аналог **Nano ID**), чтобы обеспечить баланс между читаемостью файла и абсолютной надежностью ссылок.
- **Версионирование схемы:** Каждая сцена содержит поле `version`; миграции хранятся в SceneManager и выполняются при загрузке.
- **Разрешение конфликтов:** Переопределения инстансов имеют приоритет над базовыми определениями. Дублирующиеся ID приводят к ошибке импорта.

### 5.2. Пример структуры

```yaml
# --- Metadata ---
version: 1.0
description: "Главная сцена первого уровня"

# --- Node Hierarchy ---
root:
  # Каждый узел имеет уникальный ID, тип, имя и свойства
  - id: "V1StGXR8_Z5jdHi6B-myT"
    type: "Node3D"
    name: "World"
    properties:
      position: { x: 0, y: 0, z: 0 }
      rotation: { x: 0, y: 0, z: 0 }

    # Явное определение дочерних узлов для однозначности
    children:
      - id: "b-s_1Z-4f8_c-9T_2f-3d"
        # Инстанция другой сцены (префаб)
        instance: "res://scenes/player.pix3scene"
        name: "Player"
        properties:
          # Переопределение свойств инстанции
          position: { x: 0, y: 1, z: 5 }

      - id: "k-9f_8g-7h_6j-5k_4l-1"
        type: "MeshInstance3D"
        name: "Ground"
        properties:
          # Ссылка на ассет
          mesh: "res://assets/models/ground_plane.glb"
          scale: { x: 100, y: 1, z: 100 }
```

### 5.3. Правила валидации

- Блок `root` содержит как минимум один узел.
- ID узлов уникальны во всём разрешённом графе сцены.
- Поле `instance` указывает на существующие `.pix3scene`; SceneManager резолвит путь от корня проекта.
- Дополнительный блок `metadata` хранит теги аналитики, ключи локализации и QA-заметки.
- CI запускает статическую проверку (AJV + сгенерированная JSON-схема) для всех сцен в репозитории.

## 6. План MVP (Minimum Viable Product)

- Настройка проекта с Vite, TypeScript и Lit, подключение ESLint, Prettier, Vitest и CI.
- Реализация базовой архитектуры: AppState на Valtio, контракты команд и конфигурация DI.
- Интеграция FileSystemAPIService для открытия папки проекта, списка ассетов и загрузки `.pix3scene`.
- Интеграция Golden Layout: базовая раскладка (Scene Tree, Viewport, Inspector, Asset Browser) и пресеты для персон.
- Рендеринг сцены в Three.js с перспективным вьюпортом и ортографическим 2D-проходом (единый движок).
- SceneManager для парсинга и отображения структуры `.pix3scene`, эмитящий диффы.
- Плагин `pix3-basic-tools-plugin` с инструментом создания примитивов и undoable-командами.
- Undo/Redo через HistoryManager, связанные с горячими клавишами и UI.
- Пресет экспорта playable-рекламы (HTML-бандл) и заготовка событий аналитики.

## 7. Нефункциональные требования

- **Производительность:** ≥ 85 FPS во вьюпорте на базовом железе. Холодный старт < 6 сек, тёплая перезагрузка < 2 сек. Команды обновляют UI ≤ 80 мс.
- **Доступность:** Минимум WCAG 2.1 AA для интерфейса, клавиатурная навигация по панелям и палитре команд. Включить пресет высокой контрастности.
- **Безопасность и приватность:** Данные проектов не покидают устройство. File System Access запрашивает разрешения на сессию, хендлы кэшируются в IndexedDB по согласию. Плагины работают в воркерах и требуют явных прав на сервисы.
- **Надёжность:** Автосохранение раскладки и состояния каждые 30 секунд. История undo минимум 100 команд.
- **Интернационализация:** UI использует i18n-ключи; английская и русская локализации входят в MVP. YAML-сцены допускают локализованные строки в блоках `locale`.

## 8. Структура проекта

```
/
├── dist/                     # Папка для скомпилированного приложения
├── public/                   # Статические ресурсы (иконки, шрифты)
├── src/
│   ├── ui/                   # UI компоненты (панели, оболочка)
│   │   ├── object-inspector/
│   │   ├── scene-tree/
│   │   ├── viewport/
│   │   └── welcome/
│   ├── core/                 # Ядро (operations-first, история, раскладка)
│   │   ├── features/
│   │   │   ├── selection/
│   │   │   │   ├── commands/
│   │   │   │   └── operations/
│   │   │   ├── properties/
│   │   │   │   ├── commands/
│   │   │   │   └── operations/
│   │   │   ├── scene/
│   │   │   │   ├── commands/
│   │   │   │   └── operations/
│   │   │   └── history/
│   │   │       └── commands/   # Команды Undo/Redo (тонкие)
│   │   ├── operations/         # OperationService и базовые типы/события
│   │   ├── history/            # HistoryManager
│   │   ├── layout/             # Golden Layout
│   │   └── scene/              # SceneManager и помощники
│   
│   ├── services/             # Инфраструктурные сервисы (взаимодействие с "внешним миром")
│   │   ├── FileSystemAPIService.ts
│   │   └── CollaborationService.ts (для будущего)
│   
│   ├── state/                # Глобальное состояние приложения
│   │   ├── AppState.ts       # Определение состояния (с Valtio)
│   │   └── index.ts          # Экспорт прокси состояния
│   
│   ├── rendering/            # Активные сервисы и хелперы рендера Three.js (перспектива + орто)
│   
│   ├── styles/               # Глобальные стили
│   │   └── main.css
│   
│   ├── utils/                # Вспомогательные функции
│   
│   └── main.ts               # Точка входа приложения
│
├── index.html
├── package.json
├── tsconfig.json
└── vite.config.ts

```

## 9. Дорожная карта

1. **Милстоун 0 — Foundation (4 недели):** Bootstrap репозитория, DI-хелперы, оболочка интерфейса, базовое состояние, CI.
2. **Милстоун 1 — Scene Authoring (6 недель):** MVP SceneManager, цикл рендера, браузер ассетов, инструменты примитивов.
3. **Милстоун 2 — Playable Export (4 недели):** Пресет экспорта, аналитический слой, полировка undo/redo, документация SDK плагинов.
4. **Милстоун 3 — Collaboration Preview (post-MVP):** Совместные сессии, комментарии, живые курсоры.

## 11. Управление состоянием плагинов

Плагины в Pix3 могут управлять своим собственным состоянием, отдельным от основного состояния приложения. Это обеспечивает большую гибкость и инкапсуляцию функциональности. Каждый плагин может определять свою структуру состояния и логику управления, используя Valtio или любое другое предпочтительное решение для управления состоянием.

### 11.1. Жизненный цикл состояния плагина

- **Инициализация:** Плагины могут инициализировать своё состояние при загрузке. Это идеальное время для установки значений по умолчанию и подготовки необходимых структур данных.
- **Обновления:** Плагины должны реагировать на релевантные события или команды для обновления состояния. Это может включать внешние события (например, изменения файлов) или внутренние события (например, действия пользователя).
- **Персистентность:** Плагины могут сохранять своё состояние в локальном хранилище или других решениях хранения по мере необходимости. Это позволяет пользователям сохранять настройки и данные между сессиями.
- **Утилизация:** При выгрузке плагина он должен очищать любые ресурсы, слушатели или интервалы, которые он создал. Это предотвращает утечки памяти и обеспечивает производительность приложения.

### 11.2. Пример управления состоянием плагина

```typescript
import { proxy, subscribe } from 'valtio';

// Определение состояния плагина
const pluginState = proxy({
  count: 0,
  text: 'Hello Pix3',
});

// Подписка на изменения состояния
subscribe(pluginState, () => {
  console.log('Plugin state updated:', pluginState);
});

// Обновление состояния
pluginState.count += 1;
pluginState.text = 'Updated text';
```

### 11.3. Лучшие практики

- Держите состояние плагина изолированным от основного состояния приложения, чтобы избежать непреднамеренных побочных эффектов.
- Используйте описательные и последовательные имена для свойств состояния, чтобы обеспечить ясность и поддерживаемость.
- Документируйте структуру состояния и любую важную логику, чтобы помочь другим разработчикам (и вашему будущему себе).
- Учитывайте последствия для производительности при проектировании логики управления состоянием, особенно для больших или сложных состояний.

## 10. Журнал изменений

- **1.5 (26.09.2025):** Добавлены персоны, целевые платформы, нефункциональные требования, расширенные архитектурные контракты, правила валидации и обновлённая дорожная карта. Согласованы рекомендации по `fw`.
- **1.7 (01.10.2025):** Удалён план PixiJS; консолидирован рендеринг на едином пайплайне Three.js (перспектива + ортографическая камера). Обновлена структура проекта и удалены устаревшие ссылки на адаптер.
 - **1.8 (05.10.2025):** Принят подход operations-first. Команды — тонкие фасады, делегирующие в `OperationService`. UI вызывает операции напрямую. Код организован по фичам: `core/features/*/{commands,operations}`. `CommandOperationAdapter` помечен как устаревший в документации.
